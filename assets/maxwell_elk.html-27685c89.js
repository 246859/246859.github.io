import{_ as l,W as p,X as o,Y as i,Z as a,$ as s,a0 as e,a1 as t,C as r}from"./framework-a4c02b8f.js";const c={},d=a("h1",{id:"maxwell同步mysql数据到elk",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#maxwell同步mysql数据到elk","aria-hidden":"true"},"#"),s(" Maxwell同步MySQL数据到ELK")],-1),u=a("img",{src:"https://public-1308755698.cos.ap-chongqing.myqcloud.com//upload/202409201602228.png",style:{zoom:"150%"}},null,-1),m=t(`<hr><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>Maxwell是一个Zendesk开源的MySQL数据库实时捕获和同步的工具，它基于MySQL binlog，并输出JSON格式的数据流，类似的工具还有阿里开源的canal，debezium等，不过后者支持的数据类型更丰富，通过将数据推送到Elasticsearch中，就可以实现MySQL所做不到的大数据量级的全文检索，不过一般很少会直接推送的Elasticsearch，中间会经过一个消息队列，它的好处在于可以堆积消息，因为消息是持久化的，即便突然宕机，堆积的消息在机器重启后依然可以被消费而不至于丢失，在这种情况下，数据的流向如下所示</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mysql binlog -&gt; maxwell -&gt; mq -&gt; logstash -&gt; elasticsearch
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>本文会讲解如何通过Maxwell将Mysql数据中的变化增量输出到Logstash，再通过logstash输出到Elasticsearch中，采用的MQ为Redis List，实际环境中的话建议使用kafka。</p><h2 id="准备环境" tabindex="-1"><a class="header-anchor" href="#准备环境" aria-hidden="true">#</a> 准备环境</h2><p>首先准备一台虚拟机，安装了MySQL和Redis，环境为Debian12，IP：192.168.153.130（具体地址请根据实际情况来），记得将MySQL的binlog模式修改为<code>binlog_format=row</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID   IMAGE       COMMAND                   CREATED             STATUS             PORTS                                                  NAMES
e1b0f3d4f113   mysql:8.0   <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:3306-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp, :::3306-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp, <span class="token number">33060</span>/tcp   mysql8
6b778d728ba3   redis:7.0   <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">11</span> days ago         Up <span class="token number">2</span> days          <span class="token number">0.0</span>.0.0:6379-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6379-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp              redis7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先要创建一个名为<code>maxwell</code>的数据库</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> maxwell1
<span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4
<span class="token keyword">COLLATE</span> utf8mb4_bin<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后创建一个<code>maxwell</code>用户，赋予对应权限</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 创建用户</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">&#39;maxwell&#39;</span><span class="token variable">@&#39;%&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;123456&#39;</span><span class="token punctuation">;</span>
<span class="token comment"># 赋予用户对maxwell数据的所有访问权限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">ON</span> maxwell<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;maxwell&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span>
<span class="token comment"># 赋予用户maxwell对其他用户的限制权限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;maxwell&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,12),v={href:"https://246859.github.io/posts/code/docker/docker_install_elk.html",target:"_blank",rel:"noopener noreferrer"},k=t(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID   IMAGE                     COMMAND                   CREATED      STATUS             PORTS     NAMES
8c647eabf572   logstash:8.15.0           <span class="token string">&quot;/usr/local/bin/dock…&quot;</span>   <span class="token number">5</span> days ago   Up About an hour             logstash
391ca3e0ce8f   kibana:8.15.0             <span class="token string">&quot;/bin/tini -- /usr/l…&quot;</span>   <span class="token number">5</span> days ago   Up About an hour             kibana
04c8359bacb2   elasticsearch:8.15.0      <span class="token string">&quot;/bin/tini -- /usr/l…&quot;</span>   <span class="token number">5</span> days ago   Up About an hour             elastic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>环境准备好后才进行下面的工作。</p><h2 id="安装maxwell" tabindex="-1"><a class="header-anchor" href="#安装maxwell" aria-hidden="true">#</a> 安装maxwell</h2><p>我们将maxwell与mysql安装在同一台虚拟机，先在Dockerhub查看最新版本的tag</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//upload/202409192038996.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>将对应的镜像拉下来</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> pull zendesk/maxwell:v1.41.2
v1.41.2: Pulling from zendesk/maxwell
1efc276f4ff9: Pull complete 
a2f2f93da482: Pull complete 
12cca292b13c: Pull complete 
69e15dccd787: Pull complete 
79219af6aa7c: Pull complete 
f39f1bdf1c84: Pull complete 
3261018f1785: Pull complete 
4f4fb700ef54: Pull complete 
be1353da9f00: Pull complete 
627d862c87f8: Pull complete 
Digest: sha256:68d51e27b6de2315ea710c0fe88972d4bd246ffb2519c82a49aa90a980d6cf64
Status: Downloaded newer image <span class="token keyword">for</span> zendesk/maxwell:v1.41.2
docker.io/zendesk/maxwell:v1.41.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,7),b={href:"https://maxwells-daemon.io/config/#redis-producer",target:"_blank",rel:"noopener noreferrer"},g=t(`<ul><li>file</li><li>kafka</li><li>kinesis</li><li>sqs</li><li>sns</li><li>nats</li><li>pubsub</li><li>bigquery</li><li>rabbitmq</li><li>redis</li></ul><p>其中redis支持pubsub，stream，list三种类型，本文使用lpush类型（严格来说stream才算是像样的消息队列，不过logstash的input不支持），编写如下配置文件</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># maxwell配置</span>
<span class="token key attr-name">daemon</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">log_level</span><span class="token punctuation">=</span><span class="token value attr-value">info</span>
<span class="token key attr-name">client_id</span><span class="token punctuation">=</span><span class="token value attr-value">maxwell_1</span>

<span class="token comment"># redis生产者配置</span>
<span class="token key attr-name">producer</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
<span class="token key attr-name">redis_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.153.130</span>
<span class="token key attr-name">redis_port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token key attr-name">redis_auth</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span>
<span class="token comment"># pubsub | xadd | lpush | rpush</span>
<span class="token key attr-name">redis_type</span><span class="token punctuation">=</span><span class="token value attr-value">lpush</span>
<span class="token key attr-name">redis_key</span><span class="token punctuation">=</span><span class="token value attr-value">maxwell</span>

<span class="token comment"># 过滤器配置</span>
<span class="token key attr-name">filter</span><span class="token punctuation">=</span><span class="token value attr-value">include: lobby.*</span>

<span class="token comment"># mysql配置</span>
<span class="token key attr-name">host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.153.130</span>
<span class="token key attr-name">port</span><span class="token punctuation">=</span><span class="token value attr-value">3306</span>
<span class="token key attr-name">user</span><span class="token punctuation">=</span><span class="token value attr-value">maxwell</span>
<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span>
<span class="token key attr-name">schema_database</span><span class="token punctuation">=</span><span class="token value attr-value">maxwell</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>保存至<code>/usr/db/maxwell/config.properties</code>文件中，然后运行容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\\</span>
	<span class="token parameter variable">--name</span><span class="token operator">=</span>maxwell <span class="token punctuation">\\</span>
	<span class="token parameter variable">-v</span> /usr/db/maxwell/:/etc/maxwell/ <span class="token punctuation">\\</span>
	zendesk/maxwell:v1.41.2 <span class="token punctuation">\\</span>
	bin/maxwell <span class="token parameter variable">--config</span> /etc/maxwell/config.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完事后看看情况，可以看到正常连接到MySQL了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> logs maxwell
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:55 INFO  Maxwell - Starting Maxwell. maxMemory: <span class="token number">1545601024</span> bufferMemoryUsage: <span class="token number">0.25</span>
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:55 INFO  SchemaStoreSchema - Creating maxwell database
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:55 INFO  Maxwell - Maxwell v1.41.2 is booting <span class="token punctuation">(</span>MaxwellRedisProducer<span class="token punctuation">)</span>, starting at Position<span class="token punctuation">[</span>BinlogPosition<span class="token punctuation">[</span>binlog.000002:8104<span class="token punctuation">]</span>, <span class="token assign-left variable">lastHeartbeat</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:55 INFO  AbstractSchemaStore - Maxwell is capturing initial schema
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:55 INFO  BinlogConnectorReplicator - Setting initial binlog pos to: binlog.000002:8104
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:56 INFO  BinaryLogClient - Connected to <span class="token number">192.168</span>.153.130:3306 at binlog.000002/8104 <span class="token punctuation">(</span>sid:6379, cid:27<span class="token punctuation">)</span>
<span class="token number">2024</span>-09-19 <span class="token number">13</span>:47:56 INFO  BinlogConnectorReplicator - Binlog connected.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看maxwell数据库，能看到元数据表，就说明可以了</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> maxwell<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">-------------------+</span>
<span class="token operator">|</span> Tables_in_maxwell <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+</span>
<span class="token operator">|</span> bootstrap         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">columns</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">databases</span>         <span class="token operator">|</span>
<span class="token operator">|</span> heartbeats        <span class="token operator">|</span>
<span class="token operator">|</span> positions         <span class="token operator">|</span>
<span class="token operator">|</span> schemas           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">tables</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="测试redis" tabindex="-1"><a class="header-anchor" href="#测试redis" aria-hidden="true">#</a> 测试Redis</h2>`,10),h={href:"https://github.com/dstgo/lobby",target:"_blank",rel:"noopener noreferrer"},f=a("code",null,"lobby",-1),y=a("code",null,"lobby.servers",-1),w=t(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./lobby <span class="token parameter variable">-f</span> conf.toml
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:04:23 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> logging <span class="token keyword">in</span> level: INFO
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:04:24 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> message queue is listening
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:04:24 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> created <span class="token number">2</span> <span class="token function">cron</span> <span class="token function">jobs</span>
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:04:24 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> server is listiening at <span class="token number">127.0</span>.0.1:8080
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:06:00 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> <span class="token function">cron</span> job prepared <span class="token assign-left variable">round</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>lobby-collect <span class="token assign-left variable">entry</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">prev</span><span class="token operator">=</span><span class="token string">&quot;2024-09-19 22:06:00 +0800 CST&quot;</span> <span class="token assign-left variable">next</span><span class="token operator">=</span><span class="token string">&quot;2024-09-19 22:08:00 +0800 CST&quot;</span>
<span class="token number">2024</span>-09-19 <span class="token number">22</span>:06:12 INF <span class="token punctuation">[</span>lobby<span class="token punctuation">]</span> <span class="token function">cron</span> job finished <span class="token assign-left variable">name</span><span class="token operator">=</span>lobby-collect <span class="token assign-left variable">round</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">elapsed</span><span class="token operator">=</span><span class="token number">12</span>.0738719s <span class="token assign-left variable">entry</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">prev</span><span class="token operator">=</span><span class="token string">&quot;2024-09-19 22:06:00 +0800 CST&quot;</span> <span class="token assign-left variable">next</span><span class="token operator">=</span><span class="token string">&quot;2024-09-19 22:08:00 +0800 CST&quot;</span> <span class="token assign-left variable">result.collected</span><span class="token operator">=</span><span class="token number">23512</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过结果我们可以看到在本轮任务中收集到了<code>23512</code>条数据，并成功插入到数据库中，此时我们看看Redis中的情况</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&gt; LLEN maxwell
288763
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以看到JSON格式的消息大概如下所示</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lobby&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;secondaries&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ts&quot;</span><span class="token operator">:</span> <span class="token number">1726814525</span><span class="token punctuation">,</span>
    <span class="token property">&quot;xid&quot;</span><span class="token operator">:</span> <span class="token number">1188</span><span class="token punctuation">,</span>
    <span class="token property">&quot;commit&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">12596</span><span class="token punctuation">,</span>
        <span class="token property">&quot;sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3252044372&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;steam_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;90201905397408796&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;162.191.225.248&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">11001</span><span class="token punctuation">,</span>
        <span class="token property">&quot;owner_id&quot;</span><span class="token operator">:</span> <span class="token number">15397</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前为止Maxwell和Redis一切工作正常，接下来将需要将Redis中的消息推送到ELK中</p><h2 id="推送到elk" tabindex="-1"><a class="header-anchor" href="#推送到elk" aria-hidden="true">#</a> 推送到ELK</h2>`,7),x={href:"https://www.elastic.co/guide/en/logstash/8.15/plugins-inputs-redis.html",target:"_blank",rel:"noopener noreferrer"},q=t(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>input {
  redis {
    host =&gt; &quot;192.168.153.130&quot;
    port =&gt; 6379
    password =&gt; &quot;123456&quot;
    data_type =&gt; &quot;list&quot;
    key =&gt; &quot;maxwell&quot;
    batch_count =&gt; 2000 
  }
}

output {
  elasticsearch {
    hosts =&gt; [&quot;https://localhost:9200&quot;]
    # 索引由数据库名和表名构成
    index =&gt; &quot;maxwell-%{database}-%{table}&quot;
    user =&gt; &quot;elastic&quot;
    password =&gt; &quot;TETJ8IY+ifbt8SLc+RRQ&quot;
    ssl_enabled =&gt; true
    ssl_certificate_verification =&gt; true
    ssl_certificate_authorities =&gt; &quot;/usr/share/logstash/config/certs/http_ca.crt&quot;
    ca_trusted_fingerprint =&gt; &quot;C0E9867C7D446BFF72FE46E7E9FE3455E970A8ADB0D3DF0E1472D55DB2612CD5&quot;
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启logstash</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> restart logstash
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>登陆Kibana，查看索引情况，可以看到四张表的数据都被同步过来了。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//upload/202409201520656.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看servers索引中的其中一个文档，里面的<code>data</code>字段就是mysql中的一行数据，<code>type</code>表示的是操作类型</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//upload/202409201522955.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>至此就完成了。</p><h2 id="全量同步" tabindex="-1"><a class="header-anchor" href="#全量同步" aria-hidden="true">#</a> 全量同步</h2><p>之前的方式都是增量同步，如果你想全量同步的话，maxwell也提供了工具<code>maxwell-bootstrap</code>，它还支持where来过滤数据，它的参数如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Option                             Description                                                                                                   
------                             -----------                                                                                                   
<span class="token parameter variable">--config</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                  location of config.properties <span class="token function">file</span>                                                                            
<span class="token parameter variable">--env_config</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>              json object encoded config <span class="token keyword">in</span> an environment variable                                                         

<span class="token parameter variable">--database</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                database that contains the table to bootstrap                                                                 
<span class="token parameter variable">--table</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                   table to bootstrap                                                                                            
<span class="token parameter variable">--where</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span>                   where clause to restrict the rows bootstrapped from the specified table. e.g. my_date <span class="token operator">&gt;=</span> <span class="token string">&#39;2017-01-01 11:07:13&#39;</span>

<span class="token parameter variable">--abort</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                   bootstrap_id to abort                                                                                         
<span class="token parameter variable">--monitor</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                 bootstrap_id to monitor                                                                                       

<span class="token parameter variable">--client_id</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>               maxwell client to perform the bootstrap                                                                       
<span class="token parameter variable">--log_level</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>               log level, one of DEBUG<span class="token operator">|</span>INFO<span class="token operator">|</span>WARN<span class="token operator">|</span>ERROR. default: WARN                                                        

<span class="token parameter variable">--host</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                    mysql <span class="token function">host</span> containing <span class="token string">&#39;maxwell&#39;</span> database. default: localhost                                                  
<span class="token parameter variable">--user</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                    mysql username. default: maxwell                                                                              
<span class="token parameter variable">--password</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span>                mysql password                                                                                                
<span class="token parameter variable">--port</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                    mysql port. default: <span class="token number">3306</span>                                                                                     

<span class="token parameter variable">--replication_host</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>        mysql <span class="token function">host</span> to query. default: <span class="token punctuation">(</span>host<span class="token punctuation">)</span>                                                                          
<span class="token parameter variable">--replication_user</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>        username. default: maxwell                                                                                    
<span class="token parameter variable">--replication_password</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span>    password                                                                                                      
<span class="token parameter variable">--replication_port</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>        port. default: <span class="token number">3306</span>                                                                                           

<span class="token parameter variable">--comment</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>                 arbitrary comment to be added to every bootstrap row record                                                   
<span class="token parameter variable">--schema_database</span> <span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>         database that contains maxwell schema and state                                                               
<span class="token parameter variable">--help</span>                             display <span class="token builtin class-name">help</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用示例如下，你需要手动指定所有配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> maxwell <span class="token punctuation">\\</span>
	/app/bin/maxwell-bootstrap <span class="token parameter variable">--config</span> /etc/maxwell/config.properties <span class="token punctuation">\\</span>
	<span class="token parameter variable">--host</span> <span class="token number">192.168</span>.153.130 <span class="token parameter variable">--port</span> <span class="token number">3306</span> <span class="token parameter variable">--user</span> maxwell <span class="token parameter variable">--pasword</span> <span class="token number">123456</span> <span class="token punctuation">\\</span>
	<span class="token parameter variable">--client_id</span> maxwell_1 <span class="token punctuation">\\</span>
	<span class="token parameter variable">--database</span> lobby <span class="token parameter variable">--table</span> servers <span class="token parameter variable">--where</span> <span class="token string">&#39;id&gt;=10&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p>折腾了这么多你可能会问，为什么不直接在业务中将数据同时存到数据库和Elasticsearch中，这样不是更方便？这么做主要有几个原因，下面简单说一说。</p><p>如果你是同步存的话，因为Mysql本身的操作时间也不低，那么性能势必会降低不少。假如说是异步存的话，你可能会将其放到消息队列中，然后再定时消费，但你需要自己维护一套逻辑，如果是系统设计之初就决定要这么做了，那也不失为一个可行的方案。</p><p>但软件工程从来都不是尽善尽美的，没有人能考虑到所有的情况，如果是在项目后期业务增长遇到了数据库瓶颈才加入的Elasticsearch，前面这两种方式都需要对原有的代码进行改动，这会增加不少工作量。而通过Maxwell这类工具，直接从数据库层面就可以观测到数据的变化并汇总一个数据流，然后推送给Elasticsearch，这一套工具在外部就可以工作，不需要对原来的业务代码做过多的更改，这便是它最大的优点，除此之外maxwell还具有开箱即用，简单方便的优点。</p>`,17),_={href:"https://github.com/wushujames/mysql-cdc-projects/wiki",target:"_blank",rel:"noopener noreferrer"};function S(E,N){const n=r("ExternalLinkIcon");return p(),o("div",null,[d,u,i(" more "),m,a("p",null,[s("第二台虚拟机，安装了ELK组件，环境为Debian12，IP：192.168.153.132，（访问"),a("a",v,[s("Docker部署Elastic Stack8.x实践"),e(n)]),s("以了解如何安装ELK）")]),k,a("p",null,[s("编写配置文件，我们可以在maxwell官网看到maxwell支持的producer类型，访问"),a("a",b,[s("Reference - Maxwell's Daemon (maxwells-daemon.io)"),e(n)]),s("，大概有下面这些")]),g,a("p",null,[s("在连接到ELK之前，我们先测试下maxwell是否能正常将MySQL中的数据推送到Redis Stream中，测试服务器是"),a("a",h,[s("dstgo/lobby: Query Http Api for don't strave togehter lobby servers (github.com)"),e(n)]),s("，启动"),f,s("服务器，它会定时向"),y,s("数据库写入最新的在线服务器数据。")]),w,a("p",null,[s("接下来我们需要配置Logstash的输入源，管道配置文件如下所示，关于Redis Input的相关信息可以在"),a("a",x,[s("Plugins Inputs Redis"),e(n)]),s("中了解更多。")]),q,a("p",null,[s("如果你想了解更多有关CDC（Change Data Capture 数据捕获）工具，可以前往"),a("a",_,[s("wushujames/mysql-cdc-projects Wiki (github.com)"),e(n)]),s("。")])])}const A=l(c,[["render",S],["__file","maxwell_elk.html.vue"]]);export{A as default};
