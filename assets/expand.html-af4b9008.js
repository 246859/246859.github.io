import{_ as s,W as a,X as n,Y as c,Z as e,$ as d,a1 as i}from"./framework-a4c02b8f.js";const r={},l=e("h1",{id:"docker容器磁盘热扩容",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#docker容器磁盘热扩容","aria-hidden":"true"},"#"),d(" Docker容器磁盘热扩容")],-1),t=e("figure",null,[e("img",{src:"https://w.wallhaven.cc/full/9m/wallhaven-9mjoy1.png",alt:"",tabindex:"0",loading:"lazy"}),e("figcaption")],-1),p=e("p",null,"本文主要讲解Docker容器磁盘热扩容，不需要重启docker服务，也不需要重启容器",-1),o=i(`<hr><p>最近项目里的需求需要实现Docker容器的热扩容，前一阵子给Docker驱动换到了<code>devicemapper</code>，对容器的资源限制可以更加精确和友好，刚好记录一下整个过程。</p><h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h2><p>系统：ubuntu22.04LTS</p><p>Docker：24.00</p><p>Go版本：1.20.4</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在开始之前你需要确保Docker驱动是<code>devicemapper</code>，并且宿主机和Docker的文件系统是<code>ext4</code></p></div><h2 id="查看容器大小" tabindex="-1"><a class="header-anchor" href="#查看容器大小" aria-hidden="true">#</a> 查看容器大小</h2><p>这里拿一个nginx容器做实验，先进入容器查看一下大小，一般在创建容器时若不指定默认大小为10G。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@wyh-virtual-machine:/nginx/html<span class="token comment"># docker exec -it nginx /bin/bash</span>
root@6b5a87478fce:/<span class="token comment"># df -HT</span>
Filesystem                                                                                      Type   Size  Used Avail Use% Mounted on
/dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6 ext4    11G  156M  <span class="token number">9</span>.8G   <span class="token number">2</span>% /
tmpfs                                                                                           tmpfs   68M     <span class="token number">0</span>   68M   <span class="token number">0</span>% /dev
shm                                                                                             tmpfs   68M     <span class="token number">0</span>   68M   <span class="token number">0</span>% /dev/shm
/dev/sda3                                                                                       ext4    63G   15G   46G  <span class="token number">25</span>% /etc/hosts
tmpfs                                                                                           tmpfs  <span class="token number">8</span>.4G     <span class="token number">0</span>  <span class="token number">8</span>.4G   <span class="token number">0</span>% /proc/asound
tmpfs                                                                                           tmpfs  <span class="token number">8</span>.4G     <span class="token number">0</span>  <span class="token number">8</span>.4G   <span class="token number">0</span>% /proc/acpi
tmpfs                                                                                           tmpfs  <span class="token number">8</span>.4G     <span class="token number">0</span>  <span class="token number">8</span>.4G   <span class="token number">0</span>% /proc/scsi
tmpfs 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到rootfs的size是11G，并且文件系统类型是<code>ext4</code>，这里需要将<code>/dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6</code>记下来，后续操作会用到。</p><h2 id="准备扩容" tabindex="-1"><a class="header-anchor" href="#准备扩容" aria-hidden="true">#</a> 准备扩容</h2><p>这时回到宿主机，查看之前复制的文件系统名占用的磁盘扇区数</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@wyh-virtual-machine:/nginx/html<span class="token comment"># dmsetup table /dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6</span>
<span class="token number">0</span> <span class="token number">20971520</span> thin <span class="token number">253</span>:2 <span class="token number">23</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到扇区数是从0到20971520，假设要扩容到20G，需要的扇区数就是<code>20*1024*1024*1024/512=41943040</code>，然后再修改表</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@wyh-virtual-machine:/nginx/html<span class="token comment"># echo 0 41943040 thin 253:2 23 | dmsetup load /dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重载一下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@wyh-virtual-machine:/nginx/html<span class="token comment"># dmsetup resume /dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>再次查看扇区数</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@wyh-virtual-machine:/nginx/html# dmsetup table /dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6
0 41943040 thin 253:2 23
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到扇区已经变成了41943040，最后需要调整文件系统的大小</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@wyh-virtual-machine:/nginx/html<span class="token comment"># resize2fs /dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6</span>
resize2fs <span class="token number">1.46</span>.5 <span class="token punctuation">(</span><span class="token number">30</span>-Dec-2021<span class="token punctuation">)</span>
/dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6 上的文件系统已被挂载于 /var/lib/docker/devicemapper/mnt/40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6；需要进行在线调整大小
old_desc_blocks <span class="token operator">=</span> <span class="token number">2</span>, new_desc_blocks <span class="token operator">=</span> <span class="token number">3</span>
/dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6 上的文件系统大小已经调整为 <span class="token number">5242880</span> 个块（每块 4k）。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="确认大小" tabindex="-1"><a class="header-anchor" href="#确认大小" aria-hidden="true">#</a> 确认大小</h2><p>再次进入容器查看</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@wyh-virtual-machine:/nginx/html# docker exec -it nginx  /bin/bash
root@6b5a87478fce:/# df -HT
Filesystem                                                                                      Type   Size  Used Avail Use% Mounted on
/dev/mapper/docker-8:3-2097855-40ca4227a94fe9cd1dc00963961cc16c8fc0bd6d650e72cfc0c10bc34a9c08f6 ext4    22G  156M   20G   1% /
tmpfs                                                                                           tmpfs   68M     0   68M   0% /dev
shm                                                                                             tmpfs   68M     0   68M   0% /dev/shm
/dev/sda3                                                                                       ext4    63G   15G   46G  25% /etc/hosts
tmpfs                                                                                           tmpfs  8.4G     0  8.4G   0% /proc/asound
tmpfs                                                                                           tmpfs  8.4G     0  8.4G   0% /proc/acpi
tmpfs                                                                                           tmpfs  8.4G     0  8.4G   0% /proc/scsi
tmpfs                                                                                           tmpfs  8.4G     0  8.4G   0% /sys/firmware
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到确实变成了20G。</p>`,26);function m(u,v){return a(),n("div",null,[l,t,p,c(" more "),o])}const h=s(r,[["render",m],["__file","expand.html.vue"]]);export{h as default};
