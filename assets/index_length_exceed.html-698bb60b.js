import{_ as n,W as s,X as a,Y as i,Z as e,$ as t,a1 as r}from"./framework-a4c02b8f.js";const o={},c=e("h1",{id:"mssql索引字节数超出最大值",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#mssql索引字节数超出最大值","aria-hidden":"true"},"#"),t(" MsSQL索引字节数超出最大值")],-1),d=r(`<hr><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h2><p>最近在开发的时候遇到了一个索引上的问题，模型结构体如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Permission <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gorm<span class="token punctuation">.</span>Model
	Name   <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(255);comment:perm name;&quot;\`</span>
	Object <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(255);uniqueIndex:perm;comment:resource will be accessed;&quot;\`</span>
	Action <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(255);uniqueIndex:perm;comment:resource action;&quot;\`</span>
	Group  <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(255);uniqueIndex:perm;comment:permission group;&quot;\`</span>
	Tag    <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(255);uniqueIndex:perm;comment:perm&#39;s tag,define type of perm;&quot;\`</span>

	PermissionTable
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从中可以看到创建了一个联合唯一索引<code>perm</code>，那么在使用gorm迁移数据库时，会报如下的错误</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Specified key was too long<span class="token punctuation">;</span> max key length is <span class="token number">3072</span> bytes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>mysql已经提示说你的索引太长了，最大只能是<code>3072</code>个字节数，那么究竟占了多少个字节数呢，计算方法就是类型占用字节数，由于我的mysql版本是8.0，字符集设置的是<code>utf8mb4</code>，一般来说索引限制有两种情况</p><ul><li>ROW_FORMAT= COMPACT 或 REDUNDANT，单列索引支持的最大长达为767bytes。</li><li>ROW_FORMAT= COMPRESSED 或 DYNAMIC，单列索引支持的最大长度为3072bytes。</li></ul><p>一个字符占用的是4个字节，那么上面结构体中索引的所占用的字节就是<code>255 x 4 x 4 = 4080</code>，总共4080个字节大于3072，所以自然就无法成功创建。</p><h2 id="解决" tabindex="-1"><a class="header-anchor" href="#解决" aria-hidden="true">#</a> 解决</h2><p>既然已经发现了问题所在，那么该如何解决？在经过一顿资料查找后，总结出了几种解决办法。</p><h3 id="减少长度" tabindex="-1"><a class="header-anchor" href="#减少长度" aria-hidden="true">#</a> 减少长度</h3><p>在上面的结构中，其实很多字段是没有必要设置<code>255</code>长度的，比如对于<code>tag</code>来说，<code>50</code>的长度就差不多够用了，比如说修改成如下长度。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Permission <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gorm<span class="token punctuation">.</span>Model
	Name   <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(50);comment:perm name;&quot;\`</span>
	Object <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(100);uniqueIndex:perm;comment:resource will be accessed;&quot;\`</span>
	Action <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(50);uniqueIndex:perm;comment:resource action;&quot;\`</span>
	Group  <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(30);uniqueIndex:perm;comment:permission group;&quot;\`</span>
	Tag    <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;type:varchar(30);uniqueIndex:perm;comment:perm&#39;s tag,define type of perm;&quot;\`</span>

	PermissionTable
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>(100+50+30+30) x 4 = 840 </code>，总共840个字节，远小于3072的限制。但万一业务需要就得这么大的长度，这种情况就不适用了。</p><h3 id="前缀索引" tabindex="-1"><a class="header-anchor" href="#前缀索引" aria-hidden="true">#</a> 前缀索引</h3>`,16);function l(p,u){return s(),a("div",null,[c,i(" more "),d])}const v=n(o,[["render",l],["__file","index_length_exceed.html.vue"]]);export{v as default};
